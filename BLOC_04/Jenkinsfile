pipeline {
    agent {
        docker {
            image 'python:3.10-slim'
            args '-u root:root'
        }
    }

    environment {
        REPORT_DIR = "reports"
        UNIT_REPORT = "${REPORT_DIR}/unit"
        INTEGRATION_REPORT = "${REPORT_DIR}/integration"
        WORK_DIR = "AIA/BLOC_04"
    }

    stages {
        stage('Install dependencies') {
            steps {
                sh '''
                    cd ${WORK_DIR}
                    apt-get update && apt-get install -y --no-install-recommends gcc
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }

        stage('Run unit tests') {
            steps {
                sh '''
                    cd ${WORK_DIR}
                    mkdir -p ${REPORT_DIR}/unit
                    pytest tests/unit \
                        --junitxml=${REPORT_DIR}/unit/report.xml \
                        --html=${REPORT_DIR}/unit/report.html \
                        --self-contained-html
                '''
            }
        }

        stage('Run integration tests') {
            steps {
                sh '''
                    cd ${WORK_DIR}
                    mkdir -p ${REPORT_DIR}/integration
                    pytest tests/integration \
                        --junitxml=${REPORT_DIR}/integration/report.xml \
                        --html=${REPORT_DIR}/integration/report.html \
                        --self-contained-html
                '''
            }
        }

        stage('Publish reports') {
            steps {
                junit allowEmptyResults: true, testResults: "${WORK_DIR}/${REPORT_DIR}/**/report.xml"
                publishHTML(target: [
                    reportDir: "${WORK_DIR}/${REPORT_DIR}/unit",
                    reportFiles: "report.html",
                    reportName: "Unit Tests"
                ])
                publishHTML(target: [
                    reportDir: "${WORK_DIR}/${REPORT_DIR}/integration",
                    reportFiles: "report.html",
                    reportName: "Integration Tests"
                ])
            }
        }
    }

    post {
        success {
            echo "✅ All tests passed!"
            script {
                emailext(
                    subject: "✅ Tests réussis - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        <p>Bonjour,</p>
                        <p>Les tests de <b>${env.JOB_NAME}</b> (build #${env.BUILD_NUMBER}) ont été exécutés avec succès.</p>
                        <p>Vous pouvez consulter les rapports détaillés :</p>
                        <ul>
                          <li><a href="${env.BUILD_URL}HTML_20Report_20(Unit_20Tests)/report.html">Unit Tests</a></li>
                          <li><a href="${env.BUILD_URL}HTML_20Report_20(Integration_20Tests)/report.html">Integration Tests</a></li>
                        </ul>
                        <p>Cordialement,<br/>Jenkins CI</p>
                    """,
                    to: 'enguyen.fr@gmail.com',
                    from: 'enguyen.fr@gmail.com',
                    replyTo: 'enguyen.fr@gmail.com',
                    mimeType: 'text/html'
                )
            }
        }

        failure {
            echo "❌ Some tests failed."
            script {
                emailext(
                    subject: "❌ Échec des tests - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        <p>Bonjour,</p>
                        <p>Les tests de <b>${env.JOB_NAME}</b> (build #${env.BUILD_NUMBER}) ont échoué.</p>
                        <p>Consultez les rapports détaillés :</p>
                        <ul>
                          <li><a href="${env.BUILD_URL}HTML_20Report_20(Unit_20Tests)/report.html">Unit Tests</a></li>
                          <li><a href="${env.BUILD_URL}HTML_20Report_20(Integration_20Tests)/report.html">Integration Tests</a></li>
                        </ul>
                        <p>Merci de corriger les erreurs dès que possible.</p>
                        <p>Cordialement,<br/>Jenkins CI</p>
                    """,
                    to: 'enguyen.fr@gmail.com',
                    from: 'enguyen.fr@gmail.com',
                    replyTo: 'enguyen.fr@gmail.com',
                    mimeType: 'text/html'
                )
            }
        }
    }
}
